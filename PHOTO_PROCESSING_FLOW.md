# –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ - –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

## –û–±–∑–æ—Ä
–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ –≤ –±–æ—Ç–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤: –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ü–µ–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

---

## –®–ê–ì 1: –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ

### 1.1. –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "üì∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ"
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:300-307`
- **–¢—Ä–∏–≥–≥–µ—Ä**: Callback query —Å –¥–∞–Ω–Ω—ã–º–∏ `'send_photo'`
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: `MESSAGES.PHOTO.SEND_REQUEST` ("–û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –≤ —á–∞—Ç –∏ –ø–æ–º–Ω–∏, –∂–∏—Ä –Ω–µ –ø—Ä–æ–π–¥–µ—Ç!")
  2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ü–µ–Ω—É `waiting_for_photo` —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ `GO_TO_WAITING_FOR_PHOTO`
  3. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis —á–µ—Ä–µ–∑ StateService

### 1.2. –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–±–µ–∑ –∫–Ω–æ–ø–∫–∏)
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:554-561` –∏ `563-592`
- **–¢—Ä–∏–≥–≥–µ—Ä—ã**:
  - `ctx.message?.photo` - —Ñ–æ—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É Telegram
  - `ctx.message?.document` - —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **–î–µ–π—Å—Ç–≤–∏—è**: –ü–µ—Ä–µ—Ö–æ–¥ —Å—Ä–∞–∑—É –∫ —à–∞–≥—É 2

---

## –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

### 2.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:462-472`
- **–£—Å–ª–æ–≤–∏—è**: –§–æ—Ç–æ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ —Å—Ü–µ–Ω–∞—Ö:
  - `waiting_for_photo` - –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
  - `challenge_stats` - –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∑–∏–ª —Ñ–æ—Ç–æ
- **–ï—Å–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç**: 
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: `MESSAGES.PHOTO.CLICK_BUTTON`
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –Ω–∞ `challenge_stats`

### 2.2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:474-476`
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
  2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  3. –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: `YYYY-MM-DD` (—á–µ—Ä–µ–∑ `getCurrentDateString`)

### 2.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:478-483`
- **–£—Å–ª–æ–≤–∏–µ**: –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂
- **–ï—Å–ª–∏ –Ω–µ—Ç**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `MESSAGES.CHALLENGE.NOT_ACTIVE` –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

### 2.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ–ª–ª–µ–Ω–¥–∂–∞
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:485-491`
- **–£—Å–ª–æ–≤–∏–µ**: –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'active'`
- **–ï—Å–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `MESSAGES.CHALLENGE.ALREADY_COMPLETED`, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `start`

### 2.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞ –¥–µ–Ω—å
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:493-499`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: `challengeService.hasPhotoUploadedToday(userId, currentDate)`
- **–õ–æ–≥–∏–∫–∞**: 
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–ª—é—á Redis: `photo_upload:${userId}:${date}`
  - –ï—Å–ª–∏ –∫–ª—é—á —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è
- **–ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `MESSAGES.PHOTO.ALREADY_UPLOADED` ("–í–∏–∂—É –≤—Ç–æ—Ä—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É - –æ–≥–æ–Ω—å...")

---

## –®–ê–ì 3: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞

### 3.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:502-507`
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä**: 20 –ú–ë (20 * 1024 * 1024 –±–∞–π—Ç)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**:
  - –î–ª—è —Ñ–æ—Ç–æ: `photo.file_size`
  - –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: `document.file_size`
- **–ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `MESSAGES.PHOTO.FILE_TOO_LARGE` –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

### 3.2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ Telegram
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:509-515`
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `ctx.api.getFile(fileId)`
  2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL: `https://api.telegram.org/file/bot${BOT_TOKEN}/${file.file_path}`
  3. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `fetch()`
  4. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Buffer: `Buffer.from(await response.arrayBuffer())`

### 3.3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:427-459` (—Ñ—É–Ω–∫—Ü–∏—è `validateImage`)
- **–ü—Ä–æ–≤–µ—Ä–∫–∏**:
  1. **–†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**:
     - –ú–∏–Ω–∏–º—É–º: 100x100px
     - –ú–∞–∫—Å–∏–º—É–º: 10000x10000px
  2. **–§–æ—Ä–º–∞—Ç**:
     - –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ: `jpeg`, `jpg`, `png`, `webp`
     - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `sharp.metadata().format`
- **–ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –æ—à–∏–±–∫–∞:
  - `MESSAGES.PHOTO.INVALID_SIZE` - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  - `MESSAGES.PHOTO.INVALID_FORMAT` - –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç

### 3.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME —Ç–∏–ø–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:575-582`
- **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ MIME —Ç–∏–ø—ã**: `image/jpeg`, `image/jpg`, `image/png`, `image/webp`
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ü–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞ (`.jpg`, `.jpeg`, `.png`, `.webp`)
- **–ï—Å–ª–∏ –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `MESSAGES.PHOTO.INVALID_FORMAT`

---

## –®–ê–ì 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### 4.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–Ω—è
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:524-528`
- **–õ–æ–≥–∏–∫–∞**:
  - –ï—Å–ª–∏ —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `challenge.successfulDays`
  - –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º `challenge.successfulDays + 1`

### 4.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Sharp
- **–ú–µ—Å—Ç–æ**: `src/utils/image-processor.ts:processImage()`
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
  - `imageBuffer` - –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  - `dayNumber` - –Ω–æ–º–µ—Ä –¥–Ω—è (–¥–ª—è —Ç–µ–∫—Å—Ç–∞ "Day X/30")
  - `totalDays` - –æ–±—â–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)

### 4.3. –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–®—Ä–∏—Ñ—Ç**: Custom font `VintageCulture` –∏–∑ `assets/fonts/vintage-culture-font.ttf`
- **Fallback**: Arial, –µ—Å–ª–∏ —à—Ä–∏—Ñ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
- **–¢–µ–∫—Å—Ç—ã**:
  1. –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: `"Jiroboy"` (–º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞)
  2. –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: `"Day ${dayNumber}/${totalDays}"` (–±–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞)
- **–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  - `bottomFontSize = max(32, height * 0.05)`
  - `topFontSize = bottomFontSize * 0.6`

### 4.4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
- **–ú–µ—Å—Ç–æ**: `src/utils/image-processor.ts:116-145`
- **–õ–æ–≥–∏–∫–∞**:
  1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –æ–±–ª–∞—Å—Ç—å –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É (25% —à–∏—Ä–∏–Ω—ã, 12% –≤—ã—Å–æ—Ç—ã)
  2. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å—Ä–µ–¥–Ω—è—è —è—Ä–∫–æ—Å—Ç—å –æ–±–ª–∞—Å—Ç–∏
  3. –ï—Å–ª–∏ —è—Ä–∫–æ—Å—Ç—å < 128 ‚Üí –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç
  4. –ï—Å–ª–∏ —è—Ä–∫–æ—Å—Ç—å >= 128 ‚Üí —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
- **–¶–µ–ª—å**: –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –ª—é–±–æ–º —Ñ–æ–Ω–µ

### 4.5. –ù–∞–ª–æ–∂–µ–Ω–∏–µ SVG –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–ú–µ—Ç–æ–¥**: `sharp.composite()` —Å SVG –≤ –∫–∞—á–µ—Å—Ç–≤–µ overlay
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

---

## –®–ê–ì 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 5.1. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:533-536`
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –°–æ–∑–¥–∞–Ω–∏–µ `InputFile` –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞
  2. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ `ctx.replyWithPhoto()`
  3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–π —Ñ—Ä–∞–∑—ã –∫–∞–∫ caption —á–µ—Ä–µ–∑ `getRandomMotivationalPhrase()`

### 5.2. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –¥–Ω–µ–π
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:538-541`
- **–£—Å–ª–æ–≤–∏–µ**: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è (`!alreadyUploaded`)
- **–î–µ–π—Å—Ç–≤–∏—è** (–≤ `challengeService.incrementSuccessfulDays`):
  1. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `challenge.successfulDays` –Ω–∞ 1
  2. –û–±–Ω—É–ª–µ–Ω–∏–µ `challenge.daysWithoutWorkout` (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)
  3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∫–ª—é—á–∞ `photo_upload:${userId}:${date}` —Å–æ —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏ 24 —á–∞—Å–∞

### 5.3. –í–æ–∑–≤—Ä–∞—Ç –≤ —Å—Ü–µ–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:543-547`
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è `GO_TO_CHALLENGE_STATS`
  2. –í—ã–∑–æ–≤ `handleChallengeStatsScene(ctx)` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## –®–ê–ì 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 6.1. –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–ú–µ—Å—Ç–æ**: `src/bot/middleware.ts:548-551`
- **–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ**:
  1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `logger.error()`
  2. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: `MESSAGES.PHOTO.PROCESS_ERROR`
  3. –û—à–∏–±–∫–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞

### 6.2. –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
- –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∏–∑ Telegram API
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Sharp
- –û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î –∏–ª–∏ Redis
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã/—Ä–∞–∑–º–µ—Ä—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ä–∞–Ω—å—à–µ)

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞

```
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ"]
           ‚Üì
[–ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å—Ü–µ–Ω—É waiting_for_photo]
           ‚Üì
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ/–¥–æ–∫—É–º–µ–Ω—Ç]
           ‚Üì
[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω—ã] ‚Üí –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∞—è? ‚Üí [–°–æ–æ–±—â–µ–Ω–∏–µ + –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ stats]
           ‚Üì –ü–æ–¥—Ö–æ–¥—è—â–∞—è
[–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞] ‚Üí –ù–µ—Ç? ‚Üí [–°–æ–æ–±—â–µ–Ω–∏–µ + –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ]
           ‚Üì –ï—Å—Ç—å
[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞] ‚Üí –ù–µ active? ‚Üí [–°–æ–æ–±—â–µ–Ω–∏–µ + –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ start]
           ‚Üì Active
[–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏] ‚Üí –ï—Å—Ç—å? ‚Üí [–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]
           ‚Üì –ù–µ—Ç/–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
[–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞] ‚Üí –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π? ‚Üí [–û—à–∏–±–∫–∞ + –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ]
           ‚Üì OK
[–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏–∑ Telegram]
           ‚Üì
[–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è] ‚Üí –ù–µ–≤–∞–ª–∏–¥–Ω–æ? ‚Üí [–û—à–∏–±–∫–∞ + –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ]
           ‚Üì –í–∞–ª–∏–¥–Ω–æ
[–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–Ω—è]
           ‚Üì
[–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Sharp + –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞]
           ‚Üì
[–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
           ‚Üì
[–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ (–µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è)]
           ‚Üì
[–í–æ–∑–≤—Ä–∞—Ç –≤ —Å—Ü–µ–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏]
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Sharp** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **Grammy** - —Ä–∞–±–æ—Ç–∞ —Å Telegram API
- **Redis** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
- **PostgreSQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–∞
- **XState** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ —Å—Ü–µ–Ω

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 20 –ú–ë
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 100x100px
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 10000x10000px
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–ª—é—á–∞ Redis: 24 —á–∞—Å–∞ (86400 —Å–µ–∫—É–Ω–¥)

### –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `src/scenes/messages.ts:105-114`:
- `SEND_REQUEST` - –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ç–æ
- `CLICK_BUTTON` - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É
- `ALREADY_UPLOADED` - —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è
- `PROCESS_ERROR` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `INVALID_FORMAT` - –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
- `FILE_TOO_LARGE` - —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π
- `INVALID_SIZE` - –Ω–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

