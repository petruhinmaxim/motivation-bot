import type { Context } from 'grammy';
import { InlineKeyboard } from 'grammy';
import { challengeService } from '../services/challenge.service.js';

export async function handleChallengeSettingsScene(ctx: Context) {
  const userId = ctx.from?.id;
  if (!userId) return;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
  const challenge = await challengeService.getActiveChallenge(userId);
  const remindersEnabled = challenge?.reminderStatus ?? false;

  const messageText = 
    `–ù–∏ —à–∞–≥—É –Ω–∞–∑–∞–¥, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å. –ê –≤–æ—Ç –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞`;

  const keyboard = new InlineKeyboard()
    .text('–ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å', 'change_timezone')
    .row()
    .text('–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'change_reminder_time')
    .row();

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
  if (remindersEnabled) {
    keyboard.text('üîï –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'disable_reminders');
  } else {
    keyboard.text('üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'enable_reminders');
  }

  keyboard.row().text('–ö —á–µ–ª–ª–µ–Ω–¥–∂—É', 'challenge_stats');

  // –ï—Å–ª–∏ —ç—Ç–æ callback query (–Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É), —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (ctx.callbackQuery) {
    await ctx.editMessageText(messageText, { reply_markup: keyboard });
    await ctx.answerCallbackQuery();
  } else {
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    await ctx.reply(messageText, { reply_markup: keyboard });
  }
}
